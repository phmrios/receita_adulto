<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Gerador de Prescrição por Sintoma</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        --gap: 12px;
        --muted: #6b7280;
        --border: #e5e7eb;
      }
      * { box-sizing: border-box; }
      body { margin: 24px; }
      h1, h2, h3 { margin: 0 0 10px; }
      .grid { display: grid; gap: 16px; grid-template-columns: 1fr 2fr; }
      @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
      .box { border: 1px solid var(--border); padding: 12px; border-radius: 8px; background: #fff; }
      .row { display: grid; gap: 8px; grid-template-columns: repeat(4, minmax(0,1fr)); align-items: center; }
      .row.small { grid-template-columns: repeat(2, minmax(0,1fr)); }
      label { font-size: 0.95rem; }
      input[type="text"], input[type="number"], textarea {
        width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;
      }
      textarea#saida { height: 240px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .btn { border: 1px solid var(--border); background: #f9fafb; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
      .btn:focus { outline: 3px solid #93c5fd; outline-offset: 1px; }
      .pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; margin: 3px; border: 1px solid var(--border); border-radius: 999px; }
      .muted { color: var(--muted); }
      #filtroMed { margin-bottom: 8px; }
      #live { position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden; }

      /* Impressão: mostra apenas as duas vias duplicadas */
      @media print {
        body * { visibility: hidden !important; }
        #print-sheet, #print-sheet * { visibility: visible !important; }
        #print-sheet {
          position: absolute;
          left: 0; top: 0;
          width: 100%;
          padding: 20mm;
          box-sizing: border-box;
        }
        #print-sheet div {
          page-break-after: always;
        }
        #print-sheet div:last-child {
          page-break-after: auto;
        }
      }
    </style>
  </head>
  <body>
    <h1>Gerador de Prescrição por Sintoma</h1>
    <p class="muted">Selecione os sintomas. Ajuste dose/via/intervalo/dias se desejar. Gere o texto e imprima em A4 (2 vias, 2 páginas).</p>

    <div class="grid">
      <div class="box">
        <h2>Sintomas</h2>
        <div id="sintomas-list"></div>
        <div class="row small" style="margin-top: 8px">
          <div>
            <label>Separador do cabeçalho</label>
            <input type="text" id="separador" value="—————————————" />
          </div>
          <div>
            <label>Contagem inicia em</label>
            <input type="number" id="inicioIndex" value="1" min="1" />
          </div>
        </div>
        <div class="row small" style="margin-top: 8px">
          <button class="btn" id="carregarMedicacoes">Carregar medicações</button>
          <button class="btn" id="limpar">Limpar</button>
        </div>
      </div>

      <div class="box">
        <h2>Medicações sugeridas</h2>
        <div class="row small">
          <div>
            <label for="filtroMed">Buscar medicação por nome</label>
            <input id="filtroMed" type="text" placeholder="ex.: paracetamol, ibuprofeno..." />
          </div>
        </div>
        <div id="medicacoes-container"></div>
      </div>
    </div>

    <div class="box">
      <h2>Prescrição</h2>
      <textarea id="saida"></textarea>
      <div class="row small" style="margin-top: 8px">
        <button class="btn" id="gerarPrescricao">Gerar Prescrição</button>
        <button class="btn" id="copiarPrescricao">Copiar</button>
        <button class="btn" id="imprimir">Imprimir (2 vias A4)</button>
      </div>
      <div style="margin-top: 8px">
        <label><input type="checkbox" id="tplHidratacao"> Incluir orientação de hidratação</label>
        <br>
        <label><input type="checkbox" id="tplSinaisAlarme"> Incluir sinais de alarme</label>
      </div>
    </div>

    <!-- Folha especial só para impressão -->
    <div id="print-sheet" style="display:none"></div>
    <div id="live" aria-live="polite" aria-atomic="true"></div>

    <footer style="margin-top:40px; font-size:0.85rem; color:#666; text-align:center;">
      Uso exclusivo por profissional habilitado. Ajustes podem ser necessários conforme avaliação clínica.
    </footer>

    <script>
      /* ======= Base de dados ======= */
      const MEDS_INDEX = {
        med001: "Dipirona", med002: "Paracetamol", med003: "Ciclobenzaprina",
        med004: "Ibuprofeno", med005: "Salbutamol (spray)", med006: "Beclometasona (spray)",
        med007: "Dipirona", med008: "Paracetamol", med009: "Sumatriptana", med010: "Metoclopramida",
        med011: "Paracetamol", med012: "Dipirona", med013: "Butilbrometo de escopolamina",
        med014: "Paracetamol", med015: "Dextrometorfano", med016: "Guaifenesina",
        med017: "Ondansetrona", med018: "Metoclopramida", med019: "Dimenidrinato",
        med020: "Betaistina", med021: "Propranolol", med022: "Clonazepam",
        med023: "Ondansetrona", med024: "Paracetamol",
      };

      const SINTOMAS_MEDICACOES = {
        dor_toracica_musculoesqueletica: ["med001","med002","med003","med004"],
        dispneia_broncoespasmo: ["med005","med006"],
        cefaleia: ["med007","med008","med009","med010"],
        febre: ["med011","med012"],
        dor_abdominal_colica: ["med013","med014"],
        tosse: ["med015","med016"],
        nausea_vomitos: ["med017","med018"],
        vertigem: ["med019","med020"],
        palpitacoes_benignas: ["med021","med022"],
        alteracoes_neurologicas: ["med023","med024"],
      };

      const MED_RULES = {
        med001:{forca:"500mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:6, dias:3},
        med002:{forca:"750mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:3},
        med003:{forca:"10mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:24, dias:3},
        med004:{forca:"200mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:3},
        med005:{forca:"100mcg", formaTexto:"jato", via:"inalatória", unidadesPorTomada:2, intervaloHoras:6, dias:3},
        med006:{forca:"200mcg", formaTexto:"jato", via:"inalatória", unidadesPorTomada:2, intervaloHoras:12, dias:10},
        med007:{forca:"500mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:6, dias:2},
        med008:{forca:"750mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:2},
        med009:{forca:"50mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:0, dias:1},
        med010:{forca:"10mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:1},
        med011:{forca:"750mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:3},
        med012:{forca:"500mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:6, dias:3},
        med013:{forca:"10mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:2},
        med014:{forca:"750mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:2},
        med015:{forca:"30mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:4},
        med016:{forca:"400mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:6, dias:4},
        med017:{forca:"4mg",   formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:12, dias:2},
        med018:{forca:"10mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:2},
        med019:{forca:"50mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:3},
        med020:{forca:"16mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:12, dias:5},
        med021:{forca:"10mg",  formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:3},
        med022:{forca:"0,5mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:24, dias:2},
        med023:{forca:"4mg",   formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:12, dias:1},
        med024:{forca:"750mg", formaTexto:"comprimido", via:"via oral", unidadesPorTomada:1, intervaloHoras:8, dias:1},
      };

      const LABEL_SINTOMAS = {
        dor_toracica_musculoesqueletica: "Dor torácica musculoesquelética",
        dispneia_broncoespasmo: "Dispneia por broncoespasmo",
        cefaleia: "Cefaleia",
        febre: "Febre",
        dor_abdominal_colica: "Dor abdominal cólica",
        tosse: "Tosse",
        nausea_vomitos: "Náusea e vômitos",
        vertigem: "Vertigem",
        palpitacoes_benignas: "Palpitações benignas",
        alteracoes_neurologicas: "Alterações neurológicas (pós-crise sintomático)",
      };

      const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
      const plural = (w, n) => (Number(n) === 1 ? w : w+"s");

      function formatarModoUso(unidadesPorTomada, formaTexto, via, intervaloHoras, dias) {
        const forma = formaTexto.toLowerCase() === "comp" ? "comprimido" : formaTexto;
        const viaTxt = via || "via oral";
        const horasTxt = Number(intervaloHoras)>0 ? `a cada ${intervaloHoras} ${plural("hora", intervaloHoras)}` : "se necessário";
        const diaTxt = `${dias} ${plural("dia", dias)}`;
        return `Tomar ${unidadesPorTomada} ${forma}, ${viaTxt}, ${horasTxt} por ${diaTxt}`;
      }

      function formatarCabecalho(nome, forca, quantidadeLivre, separador) {
        const base = `${nome}${forca ? " "+forca : ""}`;
        return quantidadeLivre ? `${base} ${separador} ${quantidadeLivre}` : base;
      }

      /* ============ UI ============ */
      const sintomasListEl = document.getElementById("sintomas-list");
      const container = document.getElementById("medicacoes-container");
      const filtroMed = document.getElementById("filtroMed");

      function renderSintomas() {
        sintomasListEl.innerHTML = "";
        Object.entries(LABEL_SINTOMAS).forEach(([key,label])=>{
          const w = document.createElement("label");
          w.className = "pill";
          w.innerHTML = `<input type="checkbox" value="${key}"> ${label}`;
          sintomasListEl.appendChild(w);
        });
      }
      renderSintomas();

      function getSintomasSelecionados() {
        return Array.from(sintomasListEl.querySelectorAll("input[type=checkbox]:checked")).map(x=>x.value);
      }

      function buildMedFormRow(id) {
        const nome = MEDS_INDEX[id] || id;
        const r = Object.assign({}, MED_RULES[id] || {
          forca: "", formaTexto: "comprimido", via: "via oral",
          unidadesPorTomada: 1, intervaloHoras: 8, dias: 3,
        });
        const row = document.createElement("div");
        row.className = "box";
        row.dataset.medId = id;
        row.innerHTML = `
          <div class="row">
            <label><input type="checkbox" class="inclui"> Incluir</label>
            <strong>${nome}</strong>
          </div>
          <div class="row">
            <label>Força:</label><input type="text" class="forca" value="${r.forca}">
            <label>Quantidade (para o cabeçalho)</label>
            <input type="text" class="quantidadeCab" placeholder="ex.: 20 comprimidos, 1 caixa">
            <label>Forma (uso):</label><input type="text" class="formaTexto" value="${r.formaTexto}">
            <label>Via:</label><input type="text" class="via" value="${r.via}">
          </div>
          <div class="row">
            <label>Unid/tomada:</label><input type="number" class="unidades" value="${r.unidadesPorTomada}" min="1">
            <label>Intervalo (h):</label><input type="number" class="intervalo" value="${r.intervaloHoras}" min="0" max="24">
            <label>Dias:</label><input type="number" class="dias" value="${r.dias}" min="1" max="30">
            <span class="muted">0 h = "se necessário"</span>
          </div>
        `;
        return row;
      }

      function carregarMedicacoes() {
        container.innerHTML = "";
        const sintomas = getSintomasSelecionados();
        const set = new Set();
        sintomas.forEach(s => (SINTOMAS_MEDICACOES[s]||[]).forEach(id => set.add(id)));
        const ids = Array.from(set).sort((a,b)=> (MEDS_INDEX[a]||"").localeCompare(MEDS_INDEX[b]||"","pt-BR",{sensitivity:"base"}));
        const termo = (filtroMed.value||"").trim().toLowerCase();
        ids.filter(id => !termo || (MEDS_INDEX[id]||"").toLowerCase().includes(termo))
           .forEach(id => container.appendChild(buildMedFormRow(id)));
      }

      document.getElementById("carregarMedicacoes").addEventListener("click", carregarMedicacoes);
      sintomasListEl.addEventListener("change", carregarMedicacoes);
      filtroMed.addEventListener("input", carregarMedicacoes);

      function gerarPrescricao() {
        const separador = document.getElementById("separador").value || "—————————————";
        let idx = Math.max(1, parseInt(document.getElementById("inicioIndex").value||"1",10));
        const itens = [];

        Array.from(container.querySelectorAll(".box")).forEach(box => {
          if (!box.querySelector(".inclui")?.checked) return;
          const id = box.dataset.medId;
          const nome = MEDS_INDEX[id] || id;
          const forca = box.querySelector(".forca").value.trim();
          const quantidadeCab = box.querySelector(".quantidadeCab").value.trim();
          const formaTexto = box.querySelector(".formaTexto").value.trim() || "comprimido";
          const via = box.querySelector(".via").value.trim() || "via oral";
          const unidades = clamp(parseInt(box.querySelector(".unidades").value||"1",10),1,50);
          const intervalo = clamp(parseInt(box.querySelector(".intervalo").value||"0",10),0,24);
          const dias = clamp(parseInt(box.querySelector(".dias").value||"1",10),1,30);

          const linha1 = `${idx}. ${formatarCabecalho(nome, forca, quantidadeCab, separador)}`;
          const linha2 = formatarModoUso(unidades, formaTexto, via, intervalo, dias);
          itens.push(`${linha1}\n${linha2}`);
          idx++;
        });

        const templates = [];
        if (document.getElementById("tplHidratacao").checked) templates.push("Hidratação: ingerir 30–35 mL/kg/dia, fracionando ao longo do dia.");
        if (document.getElementById("tplSinaisAlarme").checked) templates.push("Sinais de alarme: febre persistente, dispneia, vômitos incoercíveis, confusão; retornar se ocorrer.");
        if (templates.length) {
          itens.push("Orientações:", "— "+templates.join("\n— "));
        }

        const txt = itens.join("\n\n");
        document.getElementById("saida").value = txt;
        document.getElementById("live").textContent = "Prescrição gerada.";
        return txt;
      }

      document.getElementById("gerarPrescricao").addEventListener("click", gerarPrescricao);

      document.getElementById("copiarPrescricao").addEventListener("click", async()=>{
        const txt = document.getElementById("saida").value || gerarPrescricao();
        try {
          await navigator.clipboard.writeText(txt);
          document.getElementById("live").textContent = "Prescrição copiada.";
        } catch {
          document.getElementById("saida").select();
          document.execCommand("copy");
          document.getElementById("live").textContent = "Copiada (método alternativo).";
        }
      });

      function imprimir2Vias() {
        const txt = document.getElementById("saida").value || gerarPrescricao();
        const sheet = document.getElementById("print-sheet");
        sheet.innerHTML = "";
        const via = ()=> {
          const div = document.createElement("div");
          div.textContent = txt;
          div.style.whiteSpace = "pre-wrap";
          div.style.fontFamily = "Times New Roman, serif";
          div.style.fontSize = "12pt";
          div.style.marginBottom = "20mm";
          return div;
        };
        sheet.appendChild(via());
        sheet.appendChild(via());
        sheet.style.display = "block";
        window.print();
        sheet.style.display = "none";
      }
      document.getElementById("imprimir").addEventListener("click", imprimir2Vias);

      document.getElementById("limpar").addEventListener("click", ()=>{
        document.getElementById("saida").value = "";
        container.innerHTML = "";
        sintomasListEl.querySelectorAll("input").forEach(x=>x.checked=false);
      });
    </script>
  </body>
</html>